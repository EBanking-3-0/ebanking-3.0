<div class="payment-container">
  <div class="header-section">
    <h2>üí≥ Payment Service</h2>
    <p class="subtitle">Initiate and manage all payment types</p>
    <button (click)="togglePaymentsHistory()" class="history-btn">
      {{ showPaymentsHistory ? 'Hide' : 'Show' }} Payment History
    </button>
  </div>

  <!-- Tabs -->
  <div class="tabs">
    <button [class.active]="activeTab === 'internal'" (click)="setActiveTab('internal')" class="tab-btn">
      üè¶ Internal Transfer
    </button>
    <button [class.active]="activeTab === 'sepa'" (click)="setActiveTab('sepa')" class="tab-btn">
      üá™üá∫ SEPA Transfer
    </button>
    <button [class.active]="activeTab === 'instant'" (click)="setActiveTab('instant')" class="tab-btn">
      ‚ö° Instant Transfer
    </button>
    <button [class.active]="activeTab === 'mobile'" (click)="setActiveTab('mobile')" class="tab-btn">
      üì± Mobile Recharge
    </button>
  </div>

  <!-- Forms -->
  <div class="form-container">
    @if (activeTab === 'internal') {
    <form [formGroup]="internalForm" (ngSubmit)="onSubmit()" class="payment-form">
      <h3>Internal Transfer (Same Bank)</h3>
      <div class="form-group">
        <label>From Account *</label>
        <select formControlName="fromAccountId" class="form-control">
          <option [ngValue]="null" disabled>Select an account</option>
          @for (account of accounts; track account.id) {
          <option [ngValue]="account.id">
            {{ account.accountNumber }} - {{ account.balance | currency:account.currency }}
          </option>
          }
        </select>
        @if (internalForm.get('fromAccountId')?.invalid && internalForm.get('fromAccountId')?.touched) {
        <span class="error">Account ID is required</span>
        }
      </div>
      <div class="form-group">
        <label>To Account Number / IBAN *</label>
        <input type="text" formControlName="toAccountNumber" class="form-control" placeholder="Target Account Number">
        @if (internalForm.get('toAccountNumber')?.invalid && internalForm.get('toAccountNumber')?.touched) {
        <span class="error">Account Number / IBAN is required</span>
        }
      </div>
      <div class="form-group">
        <label>Amount *</label>
        <input type="number" step="0.01" formControlName="amount" class="form-control">
        @if (internalForm.get('amount')?.invalid && internalForm.get('amount')?.touched) {
        <span class="error">Amount must be greater than 0</span>
        }
      </div>
      <div class="form-group">
        <label>Currency *</label>
        <select formControlName="currency" class="form-control">
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea formControlName="description" class="form-control" rows="3"></textarea>
      </div>
      <button type="submit" [disabled]="loading || internalForm.invalid" class="submit-btn">
        @if (loading) {
        <span>Processing...</span>
        } @else {
        <span>Send Internal Transfer</span>
        }
      </button>
    </form>
    }

    @if (activeTab === 'sepa') {
    <form [formGroup]="sepaForm" (ngSubmit)="onSubmit()" class="payment-form">
      <h3>SEPA Transfer (European Transfer - 1-2 days)</h3>
      <div class="form-group">
        <label>From Account *</label>
        <select formControlName="fromAccountId" class="form-control">
          <option [ngValue]="null" disabled>Select an account</option>
          @for (account of accounts; track account.id) {
          <option [ngValue]="account.id">
            {{ account.accountNumber }} - {{ account.balance | currency:account.currency }}
          </option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>To IBAN *</label>
        <input type="text" formControlName="toIban" class="form-control" placeholder="FR1420041010050500013M02606">
        @if (sepaForm.get('toIban')?.invalid && sepaForm.get('toIban')?.touched) {
        <span class="error">Valid IBAN format required (e.g., FR1420041010050500013M02606)</span>
        }
      </div>
      <div class="form-group">
        <label>Beneficiary Name *</label>
        <input type="text" formControlName="beneficiaryName" class="form-control" placeholder="John Doe">
        @if (sepaForm.get('beneficiaryName')?.invalid && sepaForm.get('beneficiaryName')?.touched) {
        <span class="error">Beneficiary name is required</span>
        }
      </div>
      <div class="form-group">
        <label>Amount *</label>
        <input type="number" step="0.01" formControlName="amount" class="form-control">
      </div>
      <div class="form-group">
        <label>Currency *</label>
        <select formControlName="currency" class="form-control">
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
      <div class="form-group">
        <label>Description</label>
        <textarea formControlName="description" class="form-control" rows="3"></textarea>
      </div>
      <button type="submit" [disabled]="loading || sepaForm.invalid" class="submit-btn">
        @if (loading) {
        <span>Processing...</span>
        } @else {
        <span>Send SEPA Transfer</span>
        }
      </button>
    </form>
    }

    @if (activeTab === 'instant') {
    <form [formGroup]="instantForm" (ngSubmit)="onSubmit()" class="payment-form">
      <h3>Instant Transfer (SCT Inst - < 30 seconds, Max ‚Ç¨15,000)</h3>
          <div class="info-box">
            <p>‚ö° Instant transfers are processed in real-time and are irrevocable once completed.</p>
            <p>üí∞ Maximum amount: ‚Ç¨15,000</p>
          </div>
          <div class="form-group">
            <label>From Account *</label>
            <select formControlName="fromAccountId" class="form-control">
              <option [ngValue]="null" disabled>Select an account</option>
              @for (account of accounts; track account.id) {
              <option [ngValue]="account.id">
                {{ account.accountNumber }} - {{ account.balance | currency:account.currency }}
              </option>
              }
            </select>
          </div>
          <div class="form-group">
            <label>To IBAN *</label>
            <input type="text" formControlName="toIban" class="form-control" placeholder="DE89370400440532013000">
            @if (instantForm.get('toIban')?.invalid && instantForm.get('toIban')?.touched) {
            <span class="error">Valid IBAN format required</span>
            }
          </div>
          <div class="form-group">
            <label>Beneficiary Name *</label>
            <input type="text" formControlName="beneficiaryName" class="form-control" placeholder="John Doe">
            @if (instantForm.get('beneficiaryName')?.invalid && instantForm.get('beneficiaryName')?.touched) {
            <span class="error">Beneficiary name is required</span>
            }
          </div>
          <div class="form-group">
            <label>Amount * (Max: ‚Ç¨15,000)</label>
            <input type="number" step="0.01" formControlName="amount" class="form-control">
            @if (instantForm.get('amount')?.invalid && instantForm.get('amount')?.touched) {
            <span class="error">Amount must be between 0.01 and 15,000</span>
            }
          </div>
          <div class="form-group">
            <label>Currency *</label>
            <select formControlName="currency" class="form-control">
              <option value="EUR">EUR</option>
            </select>
          </div>
          <div class="form-group">
            <label>Description</label>
            <textarea formControlName="description" class="form-control" rows="3"></textarea>
          </div>
          <button type="submit" [disabled]="loading || instantForm.invalid" class="submit-btn">
            @if (loading) {
            <span>Processing...</span>
            } @else {
            <span>Send Instant Transfer</span>
            }
          </button>
    </form>
    }

    @if (activeTab === 'mobile') {
    <form [formGroup]="mobileForm" (ngSubmit)="onSubmit()" class="payment-form">
      <h3>Mobile Recharge</h3>
      <div class="form-group">
        <label>From Account *</label>
        <select formControlName="fromAccountId" class="form-control">
          <option [ngValue]="null" disabled>Select an account</option>
          @for (account of accounts; track account.id) {
          <option [ngValue]="account.id">
            {{ account.accountNumber }} - {{ account.balance | currency:account.currency }}
          </option>
          }
        </select>
      </div>
      <div class="form-group">
        <label>Phone Number *</label>
        <input type="text" formControlName="phoneNumber" class="form-control" placeholder="+33612345678">
        @if (mobileForm.get('phoneNumber')?.invalid && mobileForm.get('phoneNumber')?.touched) {
        <span class="error">Valid phone number required (e.g., +33612345678)</span>
        }
      </div>
      <div class="form-group">
        <label>Country Code *</label>
        <select formControlName="countryCode" class="form-control">
          <option value="FR">France (FR)</option>
          <option value="DE">Germany (DE)</option>
          <option value="ES">Spain (ES)</option>
          <option value="IT">Italy (IT)</option>
          <option value="GB">United Kingdom (GB)</option>
        </select>
      </div>
      <div class="form-group">
        <label>Amount *</label>
        <input type="number" step="0.01" formControlName="amount" class="form-control">
      </div>
      <div class="form-group">
        <label>Currency *</label>
        <select formControlName="currency" class="form-control">
          <option value="EUR">EUR</option>
          <option value="USD">USD</option>
          <option value="GBP">GBP</option>
        </select>
      </div>
      <button type="submit" [disabled]="loading || mobileForm.invalid" class="submit-btn">
        @if (loading) {
        <span>Processing...</span>
        } @else {
        <span>Recharge Mobile</span>
        }
      </button>
    </form>
    }
  </div>

  <!-- SCA Modal -->
  @if (scaRequired) {
  <div class="sca-modal-overlay" (click)="cancelSca()">
    <div class="sca-modal" (click)="$event.stopPropagation()">
      <h3>üîê Strong Customer Authentication (SCA)</h3>
      <p>Please enter the 6-digit OTP code sent to your registered device.</p>
      <form [formGroup]="otpForm" (ngSubmit)="onAuthorizePayment()">
        <div class="form-group">
          <label>OTP Code *</label>
          <input type="text" formControlName="otpCode" class="form-control" 
                 placeholder="000000" maxlength="6" pattern="[0-9]{6}">
          @if (otpForm.get('otpCode')?.invalid && otpForm.get('otpCode')?.touched) {
          <span class="error">Please enter a valid 6-digit OTP code</span>
          }
          @if (otpError) {
          <span class="error">{{ otpError }}</span>
          }
        </div>
        <div class="sca-actions">
          <button type="button" (click)="cancelSca()" class="btn-cancel">Cancel</button>
          <button type="submit" [disabled]="loading || otpForm.invalid" class="btn-submit">
            @if (loading) {
            <span>Authorizing...</span>
            } @else {
            <span>Authorize Payment</span>
            }
          </button>
        </div>
      </form>
    </div>
  </div>
  }

  <!-- Results -->
  @if (result && !scaRequired) {
  <div class="result-container">
    <h3>‚úÖ Payment Result</h3>
    <div class="result-card" [ngClass]="getStatusClass(result.status)">
      <div class="result-header">
        <span class="status-badge" [ngClass]="getStatusClass(result.status)">
          {{ getStatusLabel(result.status) }}
        </span>
      </div>
      <div class="result-body">
        <div class="result-row">
          <span class="label">Payment ID:</span>
          <span class="value">{{ result.paymentId }}</span>
        </div>
        <div class="result-row">
          <span class="label">Transaction ID:</span>
          <span class="value">{{ result.transactionId }}</span>
        </div>
        @if (result.paymentType) {
        <div class="result-row">
          <span class="label">Payment Type:</span>
          <span class="value">{{ getPaymentTypeLabel(result.paymentType) }}</span>
        </div>
        }
        <div class="result-row">
          <span class="label">Amount:</span>
          <span class="value">{{ result.amount | number:'1.2-2' }} {{ result.currency }}</span>
        </div>
        @if (result.fees && result.fees > 0) {
        <div class="result-row">
          <span class="label">Fees:</span>
          <span class="value">{{ result.fees | number:'1.2-2' }} {{ result.currency }}</span>
        </div>
        }
        @if (result.reference) {
        <div class="result-row">
          <span class="label">Reference:</span>
          <span class="value">{{ result.reference }}</span>
        </div>
        }
        @if (result.uetr) {
        <div class="result-row">
          <span class="label">UETR:</span>
          <span class="value">{{ result.uetr }}</span>
        </div>
        }
        <div class="result-row">
          <span class="label">Status:</span>
          <span class="value">{{ getStatusLabel(result.status) }}</span>
        </div>
        <div class="result-row">
          <span class="label">Message:</span>
          <span class="value">{{ result.message }}</span>
        </div>
        <div class="result-row">
          <span class="label">Created At:</span>
          <span class="value">{{ result.createdAt | date:'medium' }}</span>
        </div>
        @if (result.estimatedCompletionDate) {
        <div class="result-row">
          <span class="label">Estimated Completion:</span>
          <span class="value">{{ result.estimatedCompletionDate | date:'medium' }}</span>
        </div>
        }
      </div>
    </div>
  </div>
  }

  @if (error && !scaRequired) {
  <div class="error-container">
    <h3>‚ùå Error</h3>
    <div class="error-card">
      <p>{{ error }}</p>
    </div>
  </div>
  }

  <!-- Payment History -->
  @if (showPaymentsHistory) {
  <div class="history-container">
    <h3>üìã Payment History</h3>
    @if (paymentsLoading) {
    <div class="loading-message">Loading payments...</div>
    } @else if (userPayments.length === 0) {
    <div class="empty-message">No payments found.</div>
    } @else {
    <div class="payments-table">
      <table>
        <thead>
          <tr>
            <th>ID</th>
            <th>Transaction ID</th>
            <th>Type</th>
            <th>Amount</th>
            <th>Status</th>
            <th>Created At</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          @for (payment of userPayments; track payment.paymentId) {
          <tr>
            <td>{{ payment.paymentId }}</td>
            <td class="transaction-id">{{ payment.transactionId }}</td>
            <td>{{ getPaymentTypeLabel(payment.paymentType) }}</td>
            <td>{{ payment.amount | number:'1.2-2' }} {{ payment.currency }}</td>
            <td>
              <span class="status-badge" [ngClass]="getStatusClass(payment.status)">
                {{ getStatusLabel(payment.status) }}
              </span>
            </td>
            <td>{{ payment.createdAt | date:'short' }}</td>
            <td>
              <button (click)="result = payment" class="btn-view">View Details</button>
            </td>
          </tr>
          }
        </tbody>
      </table>
    </div>
    }
  </div>
  }
</div>